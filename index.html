
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dark*Light Chat</title>

<!-- CSS -->
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Courier New',monospace;height:100vh;overflow:hidden;background:#000;color:#fff}
.header{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;border-bottom:1px solid #333;background:#111;height:60px}
.logo{font-size:18px;font-weight:bold}
.controls{display:flex;gap:15px;align-items:center}
.control-btn{background:none;border:1px solid #555;padding:8px 15px;cursor:pointer;font-size:14px;border-radius:4px;color:#fff}
.control-btn:hover{background:#333}
.user-id{font-weight:bold;color:#ff4444}
.connection-status{font-size:10px;padding:2px 6px;border-radius:10px;margin-right:10px}
.connected{background:#1cda1c;color:#000}
.disconnected{background:#ff4444;color:#fff}
.chat-container{height:calc(100vh - 120px);overflow-y:auto;padding:20px;font-size:14px;line-height:1.4;display:none}
.message{margin-bottom:8px;word-wrap:break-word}
.timestamp{color:#888}
.username{font-weight:bold}
.my-username{color:#ff4444}
.other-username{color:#44ff44}
.encrypted-message{color:#666;font-style:italic}
.input-container{position:fixed;bottom:0;left:0;right:0;padding:20px;border-top:1px solid #333;background:#111;display:none}
.input-row{display:flex;align-items:center;gap:10px}
.prompt{color:#44ff44;font-weight:bold}
.message-input{flex:1;background:transparent;border:none;outline:none;font-size:14px;padding:5px;color:#fff}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000}
.modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);padding:30px;border-radius:8px;max-width:400px;width:90%;background:#222;border:1px solid #555;text-align:center}
.modal-title{font-size:18px;margin-bottom:20px}
.modal-btn{padding:10px 20px;margin:10px 0;border:1px solid #555;background:none;cursor:pointer;font-size:14px;border-radius:4px;color:#fff;width:100%}
.modal-btn:hover{background:#333}
.user-list{margin-bottom:20px}
.user-item{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:8px;border-radius:4px;cursor:pointer}
.user-item:hover{background:#333}
.user-checkbox{margin-left:10px}
.system-message{color:#888;font-style:italic;text-align:center;margin:10px 0}
.success-message{background:#44ff44;color:#000;padding:15px;margin:20px;border-radius:8px;text-align:center;font-weight:bold}
#loginForm input{width:100%;margin:5px 0;padding:8px;border:none;border-radius:4px}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>

<!-- HTML -->
<div class="header">
  <div class="logo">Dark*Light chat</div>
  <div class="controls">
    <span class="connection-status disconnected" id="connectionStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</span>
    <span class="user-id" id="userId">---</span>
    <span id="onlineCount" style="font-size:12px;color:#888">Ù…ØªØµÙ„: 0</span>
    <button class="control-btn" id="privateBtn" style="display:none;">â˜… Ø®Ø§Øµ</button>
  </div>
</div>

<div class="chat-container" id="chatContainer">
  <div class="success-message"> Ù…ØªØµÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø§Ù‡Ø²Ø©.</div>
</div>

<div class="input-container" id="inputContainer">
  <div class="input-row">
    <span class="prompt" id="promptText">guest:~$</span>
    <input type="text" class="message-input" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
  </div>
</div>

<!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
<div class="modal" id="startModal" style="display:block;">
  <div class="modal-content">
    <div class="modal-title">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
    <button class="modal-btn" id="anonStart">Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¬Ù‡ÙˆÙ„</button>
    <button class="modal-btn" id="newAcc">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
    <button class="modal-btn" id="loginAcc">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
  </div>
</div>

<!-- ÙÙˆØ±Ù… ØªØ³Ø¬ÙŠÙ„ / Ø¯Ø®ÙˆÙ„ -->
<div class="modal" id="loginForm">
  <div class="modal-content">
    <div class="modal-title" id="formTitle">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
    <input type="text" id="regName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input type="password" id="regPass" placeholder="Ø±Ù…Ø² Ø³Ø±ÙŠ (5 Ø®Ø§Ù†Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±)">
    <button class="modal-btn" id="formSubmit">ØªØ£ÙƒÙŠØ¯</button>
    <button class="modal-btn" id="cancelForm">Ø¥Ù„ØºØ§Ø¡</button>
    <div style="color:#888;font-size:12px;margin-top:10px;">Ø§Ø³Ù… Anonymous Ù…Ø­Ø¬ÙˆØ² Ù„Ù„Ù…Ø¬Ù‡ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·</div>
  </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø§Øµ -->
<div class="modal" id="privateModal">
  <div class="modal-content">
    <div class="modal-title">Ø§Ø®ØªØ± Ù…Ù† ÙŠÙ…ÙƒÙ†Ù‡ Ø±Ø¤ÙŠØ© Ø±Ø³Ø§Ø¦Ù„Ùƒ</div>
    <div class="user-list" id="userList"></div>
    <button class="modal-btn" id="applyPrivate">ØªØ·Ø¨ÙŠÙ‚</button>
    <button class="modal-btn" id="cancelPrivate">Ø¥Ù„ØºØ§Ø¡</button>
    <button class="modal-btn" id="publicMode">Ø¹Ø§Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
  </div>
</div>

<!-- JS -->
<script>
const firebaseConfig={
 apiKey:"AIzaSyD3LkYqJE5Y_TR6A6UnajL304eyL4zO2lM",
 authDomain:"darklight-chat.firebaseapp.com",
 databaseURL:"https://darklight-chat-default-rtdb.europe-west1.firebasedatabase.app",
 projectId:"darklight-chat",
 storageBucket:"darklight-chat.firebasestorage.app",
 messagingSenderId:"425772939802",
 appId:"1:425772939802:web:5ba327426570f1b0d82fa3"
};
firebase.initializeApp(firebaseConfig);
var database=firebase.database();

class DarkLightChat{
 constructor(userId){
  this.userId=userId;this.isPrivateMode=false;this.selectedUsers=new Set();this.onlineUsers=new Map();
  this.init();
 }
 init(){
  this.el={
   userId:document.getElementById('userId'),
   onlineCount:document.getElementById('onlineCount'),
   connectionStatus:document.getElementById('connectionStatus'),
   chatContainer:document.getElementById('chatContainer'),
   inputContainer:document.getElementById('inputContainer'),
   messageInput:document.getElementById('messageInput'),
   promptText:document.getElementById('promptText'),
   privateBtn:document.getElementById('privateBtn'),
   privateModal:document.getElementById('privateModal'),
   userList:document.getElementById('userList')
  };
  this.userRef=database.ref(`users/${this.userId.replace('#','_')}`);
  this.messagesRef=database.ref('messages');
  this.onlineUsersRef=database.ref('users');
  database.ref('.info/connected').on('value',snap=>{
    const c=snap.val();
    this.el.connectionStatus.textContent=c?'Ù…ØªØµÙ„':'ØºÙŠØ± Ù…ØªØµÙ„';
    this.el.connectionStatus.className='connection-status '+(c?'connected':'disconnected');
    if(c){
      this.userRef.set({userId:this.userId,lastSeen:firebase.database.ServerValue.TIMESTAMP,status:'online'});
      this.userRef.onDisconnect().remove();
    }
  });
  this.messagesRef.limitToLast(50).on('child_added',s=>{
    const d=s.val(); if(d && d.userId!==this.userId) this.displayMessage(d);
  });
  this.onlineUsersRef.on('value',s=>{
    const u=s.val()||{};this.onlineUsers.clear();
    Object.keys(u).forEach(id=>{
      const orig=id.replace('_','#');if(orig!==this.userId)this.onlineUsers.set(orig,u[id]);
    });
    this.el.onlineCount.textContent='Ù…ØªØµÙ„: '+(this.onlineUsers.size+1);
  });
  this.el.messageInput.addEventListener('keypress',e=>{if(e.key==='Enter')this.sendMessage();});
  document.getElementById('privateBtn').style.display='inline-block';
  this.el.chatContainer.style.display='block';
  this.el.inputContainer.style.display='block';
  this.el.userId.textContent=this.userId;
  this.el.promptText.textContent=`${this.userId}:~$`; // Ø­Ø°Ù @darklight
  document.getElementById('applyPrivate').onclick=()=>{this.isPrivateMode=this.selectedUsers.size>0;this.hidePrivate();};
  document.getElementById('cancelPrivate').onclick=()=>this.hidePrivate();
  document.getElementById('publicMode').onclick=()=>{this.isPrivateMode=false;this.selectedUsers.clear();this.hidePrivate();};
  document.getElementById('privateBtn').onclick=()=>this.showPrivate();
 }
 showPrivate(){this.updateUserList();this.el.privateModal.style.display='block';}
 hidePrivate(){this.el.privateModal.style.display='none';}
 updateUserList(){
  const list=this.el.userList;list.innerHTML='';
  if(this.onlineUsers.size===0){list.innerHTML='<div style="color:#888;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>';return;}
  this.onlineUsers.forEach((_,id)=>{
    const item=document.createElement('div');item.className='user-item';
    const c=document.createElement('input');c.type='checkbox';c.className='user-checkbox';
    c.checked=this.selectedUsers.has(id);
    c.onchange=e=>{e.target.checked?this.selectedUsers.add(id):this.selectedUsers.delete(id);};
    const lbl=document.createElement('span');lbl.textContent=id;lbl.className='other-username';
    item.append(c,lbl);list.appendChild(item);
  });
 }
 async sendMessage(){
  const txt=this.el.messageInput.value.trim();if(!txt)return;
  const ts=new Date().toLocaleTimeString('ar-SA',{hour:'2-digit',minute:'2-digit'});
  const data={userId:this.userId,timestamp:ts,content:txt,isPrivate:this.isPrivateMode,
              recipients:this.isPrivateMode?Array.from(this.selectedUsers):[],
              serverTimestamp:firebase.database.ServerValue.TIMESTAMP};
  this.displayMessage(data);
  await this.messagesRef.push(data);
  this.el.messageInput.value='';
 }
 displayMessage(d){
  const div=document.createElement('div');div.className='message';
  const mine=d.userId===this.userId;
  const canSee=!d.isPrivate||mine||(d.recipients||[]).includes(this.userId);
  const content=canSee?d.content:'ğŸ”’ Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©';
  const uClass=mine?'my-username':'other-username';
  const lock=d.isPrivate?' ğŸ”’':'';
  div.innerHTML=`<span class="timestamp">[${d.timestamp}]</span>
  <span class="username ${uClass}">&lt;${d.userId}&gt;</span>${lock}
  <span class="${canSee?'':'encrypted-message'}"> ${content}</span>`;
  this.el.chatContainer.appendChild(div);
  this.el.chatContainer.scrollTop=this.el.chatContainer.scrollHeight;
 }
}

async function getNextNumber(name){
 const snap=await database.ref('registeredNames/'+name).once('value');
 let n=1; if(snap.exists()) n=snap.val().count+1;
 await database.ref('registeredNames/'+name).set({count:n});
 return n;
}

function startChat(uid){
 document.getElementById('startModal').style.display='none';
 document.getElementById('loginForm').style.display='none';
 new DarkLightChat(uid);
}

/* === ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© === */
let formMode='new';

document.getElementById('anonStart').onclick=()=>{
 const num=Math.floor(Math.random()*9000)+1000;
 startChat(`Anonymous#${num}`);
};
document.getElementById('newAcc').onclick=()=>{
 formMode='new';
 document.getElementById('formTitle').textContent='ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯';
 document.getElementById('loginForm').style.display='block';
};
document.getElementById('loginAcc').onclick=()=>{
 formMode='login';
 document.getElementById('formTitle').textContent='ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„';
 document.getElementById('loginForm').style.display='block';
};
document.getElementById('cancelForm').onclick=()=>{
 document.getElementById('loginForm').style.display='none';
};

document.getElementById('formSubmit').onclick=async()=>{
 const name=document.getElementById('regName').value.trim();
 const pass=document.getElementById('regPass').value.trim();
 if(!name||!pass){alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù…Ø²');return;}
 if(pass.length<5){alert('Ø§Ù„Ø±Ù…Ø² 5 Ø®Ø§Ù†Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±');return;}
 if(/^anonymous#/i.test(name)){alert('Ø§Ø³Ù… Anonymous Ù…Ø­Ø¬ÙˆØ²');return;}

 if(formMode==='new'){
   const num=await getNextNumber(name);
   await database.ref('accounts/'+name).set({password:pass});
   startChat(`${name}#${num}`);
 }else{
   const snap=await database.ref('accounts/'+name).once('value');
   if(!snap.exists()||snap.val().password!==pass){alert('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©');return;}
   const num=await getNextNumber(name);
   startChat(`${name}#${num}`);
 }
};
</script>

</body>
</html>
